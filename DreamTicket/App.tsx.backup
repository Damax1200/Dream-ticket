import React, { useState, useEffect } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createStackNavigator } from '@react-navigation/stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import * as SplashScreenExpo from 'expo-splash-screen';
import { Text, View } from 'react-native';
import HomeScreen from './src/screens/HomeScreen';
import TicketScreen from './src/screens/TicketScreen';
import ProfileScreen from './src/screens/ProfileScreen';
import SplashScreen from './src/screens/SplashScreen';
import LoginScreen from './src/screens/LoginScreen';
import SignUpScreen from './src/screens/SignUpScreen';
import AITicketGeneratorScreen from './src/screens/AITicketGeneratorScreen';
import { AuthStackParamList, MainTabParamList } from './src/types/navigation';

const AuthStack = createStackNavigator<AuthStackParamList>();
const Tab = createBottomTabNavigator<MainTabParamList>();

// Keep the splash screen visible while we fetch resources
SplashScreenExpo.preventAutoHideAsync();

// Custom Tab Bar Icon Component
const TabBarIcon: React.FC<{ emoji: string; focused?: boolean }> = ({ emoji, focused = false }) => {
  return (
    <View style={{
      width: 60,
      height: 60,
      justifyContent: 'center',
      alignItems: 'center',
      transform: [{ scale: focused ? 1.1 : 1 }],
    }}>
      <Text style={{
        fontSize: focused ? 28 : 24,
      }}>
        {emoji || 'ðŸŽ«'}
      </Text>
    </View>
  );
};

// Auth Stack Navigator
const AuthNavigator: React.FC<{ onLogin: () => void }> = ({ onLogin }) => {
  return (
    <AuthStack.Navigator
      screenOptions={{
        headerShown: false,
      }}
    >
      <AuthStack.Screen name="Login">
        {(props) => <LoginScreen {...props} onLogin={onLogin} />}
      </AuthStack.Screen>
      <AuthStack.Screen name="SignUp">
        {(props) => <SignUpScreen {...props} onSignUp={onLogin} />}
      </AuthStack.Screen>
    </AuthStack.Navigator>
  );
};

// Main Bottom Tab Navigator
const MainTabNavigator: React.FC<{ onLogout: () => void }> = ({ onLogout }) => {
  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        headerStyle: {
          backgroundColor: '#6366f1',
        },
        headerTintColor: '#fff',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
        tabBarStyle: {
          backgroundColor: '#ffffff',
          borderTopWidth: 0,
          elevation: 20,
          shadowColor: '#000',
          shadowOffset: {
            width: 0,
            height: -4,
          },
          shadowOpacity: 0.1,
          shadowRadius: 8,
          height: 70,
          paddingBottom: 10,
          paddingTop: 10,
        },
        tabBarActiveTintColor: '#6366f1',
        tabBarInactiveTintColor: '#9ca3af',
        tabBarLabelStyle: {
          fontSize: 12,
          fontWeight: '600',
          marginTop: -5,
        },
        tabBarIconStyle: {
          marginTop: 5,
        },
      })}
    >
      <Tab.Screen
        name="HomeTab"
        component={HomeScreen}
        options={{
          title: 'Home',
          tabBarLabel: 'Home',
          tabBarIcon: ({ focused }: any) => (
            <TabBarIcon emoji="ðŸ " focused={focused || false} />
          ),
          headerTitle: 'Dream Ticket',
        }}
      />
      <Tab.Screen
        name="AIGenerator"
        component={AITicketGeneratorScreen}
        options={{
          title: 'AI Generator',
          tabBarLabel: 'AI Ticket',
          tabBarIcon: ({ focused }: any) => (
            <TabBarIcon emoji="ðŸ¤–" focused={focused || false} />
          ),
          headerTitle: 'AI Ticket Generator',
          headerStyle: {
            backgroundColor: '#8b5cf6',
          },
        }}
      />
      <Tab.Screen
        name="MyTickets"
        component={TicketScreen}
        options={{
          title: 'My Tickets',
          tabBarLabel: 'My Tickets',
          tabBarIcon: ({ focused }: any) => (
            <TabBarIcon emoji="ðŸŽ«" focused={focused || false} />
          ),
          headerTitle: 'My Tickets',
        }}
      />
      <Tab.Screen
        name="ProfileTab"
        options={{
          title: 'Profile',
          tabBarLabel: 'Profile',
          tabBarIcon: ({ focused }: any) => (
            <TabBarIcon emoji="ðŸ‘¤" focused={focused || false} />
          ),
          headerTitle: 'Profile',
        }}
      >
        {(props: any) => <ProfileScreen {...props} onLogout={onLogout} />}
      </Tab.Screen>
    </Tab.Navigator>
  );
};

const App: React.FC = () => {
  const [isReady, setIsReady] = useState<boolean>(false);
  const [showSplash, setShowSplash] = useState<boolean>(true);
  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);

  useEffect(() => {
    async function prepare() {
      try {
        // Pre-load fonts, check auth token, make any API calls you need here
        // Simulate loading time
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Check if user is already logged in (you would check AsyncStorage or similar)
        // const userToken = await AsyncStorage.getItem('userToken');
        // setIsAuthenticated(!!userToken);
      } catch (e) {
        console.warn(e);
      } finally {
        setIsReady(true);
        await SplashScreenExpo.hideAsync();
      }
    }

    prepare();
  }, []);

  const handleSplashFinish = () => {
    setShowSplash(false);
  };

  const handleLogin = () => {
    setIsAuthenticated(true);
  };

  const handleLogout = () => {
    setIsAuthenticated(false);
  };

  if (!isReady) {
    return null;
  }

  if (showSplash) {
    return <SplashScreen onFinish={handleSplashFinish} />;
  }

  return (
    <SafeAreaProvider>
      <NavigationContainer>
        {isAuthenticated ? (
          <MainTabNavigator onLogout={handleLogout} />
        ) : (
          <AuthNavigator onLogin={handleLogin} />
        )}
      </NavigationContainer>
    </SafeAreaProvider>
  );
};

export default App;
